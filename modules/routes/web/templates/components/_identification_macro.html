{# --------------------------------------------------------------------
  id_line(roll) – v7
-------------------------------------------------------------------- #}
{% macro id_line(roll) %}

    {# ------------ helper: class based on sign ----------------------- #}
    {% macro sign_class(v, suf='') %}
        {{ 'negative' ~ suf if v|float < 0 else 'positive' ~ suf }}
    {% endmacro %}

    {# 1) grab the raw value, defaulting to empty #}
    {% set pct_raw = roll.rollPercentage | default('') %}

    {# 2) figure out a numeric pct_val #}
    {% if pct_raw is number %}
        {# already a float/int → keep as-is #}
        {% set pct_val = pct_raw %}
    {% elif pct_raw and pct_raw != 'NaN' %}
        {# a non-empty string → strip “%” then float it #}
        {% set pct_val = pct_raw.rstrip('%') | float %}
    {% else %}
        {# missing or NaN → nothing #}
        {% set pct_val = none %}
    {% endif %}

    {# 3) format pct_txt if we have a number #}
    {% if pct_val is not none %}
        {% set pct_txt = '%.1f' % pct_val %}
    {% else %}
        {% set pct_txt = none %}
    {% endif %}

    {# ------------ 3 · variable? fixed? ------------------------------- #}
    {% set variable = pct_val is not none and not roll.statRange.fixed %}

    {# ------------ 4 · render ---------------------------------------- #}
    {% if variable %}
        <div class="stat-row">
            <span class="stat-value {{ sign_class(roll.statRoll) }}">
                {{- roll.statRoll -}}{% if roll.unit == 'PERCENT' %}%{% endif %}
            </span>
            <span class="stat-name">{{ roll.displayName }}</span>
            <span class="stat-pct" data-pct="{{ pct_val|default('') }}">[{{ pct_txt }}%]<span>
        </div>

    {% elif roll.statRange.fixed %}
        <div class="stat-row">
            <span class="stat-value {{ sign_class(roll.statRoll) }}">
                {%- if roll.unit == 'PERCENT' -%}
                    {{- roll.statRoll -}}%
                {%- elif roll.unit == 'TIER' -%}
                    {{- roll.statRoll -}} tier
                {%- else -%}
                    {{- roll.statRoll -}}
                {%- endif -%}
            </span>
            <span class="stat-name">{{ roll.displayName }}</span>
            <span class="stat-pct"></span>
        </div>

    {% else %}
        <div class="stat-row">
            <span class="stat-value {{ sign_class(roll.statRange.low) }}">
                {{- roll.statRange.low -}}{% if roll.unit == 'PERCENT' %}%{% endif %}
                 to
                {{- roll.statRange.high -}}{% if roll.unit == 'PERCENT' %}%{% endif %}
            </span>
            <span class="stat-name">{{ roll.displayName }}</span>
            <span class="stat-pct"></span>
        </div>
    {% endif %}

{% endmacro %}
