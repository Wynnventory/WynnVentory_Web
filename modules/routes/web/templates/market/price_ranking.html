{% extends '/components/_base.html' %}
{% block title %}Price History{% endblock %}
{% block content %}
    <style>
        /* shrink the Su, Mo, Tuâ€¦ headers */
        .datepicker-days thead th {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        /* DataTables responsive styles */
        .dataTables_wrapper {
            width: 100%;
            margin-bottom: 2rem;
        }

        /* Make sure table is responsive */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }

        /* Style for DataTables filter and pagination */
        .dataTables_filter, .dataTables_paginate {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        /* Ensure table fits on mobile */
        @media (max-width: 767px) {
            .dataTables_wrapper .dataTables_filter {
                text-align: left;
                margin-top: 0.5rem;
            }

            .dataTables_wrapper .dataTables_length,
            .dataTables_wrapper .dataTables_filter {
                float: none;
                width: 100%;
            }
        }
    </style>
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

    <div class="container mt-5">
        <h2>Item Rankings</h2>
        <p class="text-muted">Based on archived data.</p>

        <!-- Date range selectors (hidden until 'Date Range' clicked) -->
        <div class="row mb-3" id="dateRangeContainer" style="display: none;">
            <div class="col-md-3 mb-3">
                <label for="startDate" class="form-label">Start Date</label>
                <input type="text" class="form-control" id="startDate" placeholder="YYYY-MM-DD">
            </div>
            <div class="col-md-3 mb-3">
                <label for="endDate" class="form-label">End Date</label>
                <input type="text" class="form-control" id="endDate" placeholder="YYYY-MM-DD">
            </div>
            <div class="col-md-3 mb-3 d-flex align-items-end">
                <button id="applyFilter" class="btn btn-primary me-2">Apply</button>
                <button id="resetFilter" class="btn btn-secondary">Reset</button>
            </div>
        </div>

        <!-- Quick timeframe toggles -->
        <div class="row mb-3">
            <div class="col">
                <div class="btn-group btn-group-sm" role="group" aria-label="Timeframe toggles">
                    <button type="button" class="btn btn-primary" id="btn7" onclick="updateTimeframe(7, this)">Last 7
                        days
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="btn14"
                            onclick="updateTimeframe(14, this)">Last 14 days
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="btn30"
                            onclick="updateTimeframe(30, this)">Last Month
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="btn90"
                            onclick="updateTimeframe(90, this)">Last 3 Months
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="btnRange"
                            onclick="activateDateRange(this)">Date Range
                    </button>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped" id="rankingTable">
                <thead>
                <tr>
                    <th>Rank</th>
                    <th>Item Name</th>
                    <th>Avg Price</th>
                    <th>Lowest</th>
                    <th>Highest</th>
                    <th>Mid 80% Avg</th>
                    <th>Unid Mid 80% Avg</th>
                    <th>Total Items</th>
                    <th>Total Unid Items</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Chart.js and date adapter -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.js"
            integrity="sha512-L0Shl7nXXzIlBSUUPpxrokqq4ojqgZFQczTYlGjzONGTDAcLremjwaWv5A+EDLnxhQzY5xUZPWLOLqYRkY0Cbw=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script>
        // Utilities
        function capitalizeWords(str) {
            const small = ['of'];
            return str.split(' ').map((w, i) => (i === 0 || !small.includes(w.toLowerCase()))
                ? w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()
                : w.toLowerCase()
            ).join(' ');
        }

        function convertEmeraldsToGameFormat(emeralds) {
            let rem = Math.floor(emeralds);
            const stx = Math.floor(rem / (64 * 64 * 64));
            rem %= 64 * 64 * 64;
            const le = Math.floor(rem / (64 * 64));
            rem %= 64 * 64;
            const eb = Math.floor(rem / 64);
            rem %= 64;
            let res = '';
            if (stx > 0) {
                let dec = le + eb / 64 + rem / (64 * 64);
                dec = Math.round(dec * 100) / 100;
                res = `${stx}stx${dec !== 0 ? ` ${dec}le` : ''}`;
            } else {
                if (le) res += `${le}le `;
                if (eb) res += `${eb}eb `;
                if (rem) res += `${rem.toFixed(2)}e`;
            }
            return res.trim() || '0e';
        }

        // State
        let currentStart = '';
        let currentEnd = '';
        let currentTimeframe = 7;
        const DEFAULT_LAG = 1;
        const MS_PER_DAY = 86400000;

        // Quick selectors hide date inputs
        function updateTimeframe(days, btn) {
            history.replaceState(null, '', location.pathname);
            document.getElementById('dateRangeContainer').style.display = 'none';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            currentTimeframe = days;
            document.querySelectorAll('.btn-group button').forEach(b => {
                b.classList.replace('btn-primary', 'btn-outline-primary');
                b.classList.remove('active');
            });
            btn.classList.replace('btn-outline-primary', 'btn-primary');
            btn.classList.add('active');
            fetchAndDisplay();
        }

        // Show date inputs
        function activateDateRange(btn) {
            document.querySelectorAll('.btn-group button').forEach(b => {
                b.classList.replace('btn-primary', 'btn-outline-primary');
                b.classList.remove('active');
            });
            btn.classList.replace('btn-outline-primary', 'btn-primary');
            btn.classList.add('active');
            document.getElementById('dateRangeContainer').style.display = 'flex';
        }

        // Fetch data
        async function fetchAndDisplay() {
            // Date values
            let s = document.getElementById('startDate').value;
            let e = document.getElementById('endDate').value;
            if (!s && !e) {
                const now = new Date();
                const lag = new Date(now.getTime() - DEFAULT_LAG * MS_PER_DAY);
                e = lag.toISOString().split('T')[0];
                s = new Date(lag.getTime() - currentTimeframe * MS_PER_DAY).toISOString().split('T')[0];
            }
            currentStart = s;
            currentEnd = e;
            const params = new URLSearchParams({start_date: s, end_date: e});
            const res = await fetch('/api/trademarket/ranking?' + params);
            const data = await res.json();
            displayRanking(data || []);
        }

        // DataTable instance variable
        let dataTable = null;

        // Populate table
        function displayRanking(items) {
            const tbody = document.querySelector('#rankingTable tbody');
            const dateModeVisible = document.getElementById('dateRangeContainer').style.display !== 'none';

            // Destroy existing DataTable if it exists
            if (dataTable) {
                dataTable.destroy();
                dataTable = null;
            }

            tbody.innerHTML = '';

            items.forEach(it => {
                const params = new URLSearchParams();

                if (!dateModeVisible) {
                    // Quick-selector mode: use currentStart/currentEnd
                    if (currentStart) params.append('start_date', currentStart);
                    if (currentEnd) params.append('end_date', currentEnd);
                } else {
                    // Date-range mode: read whatever the user has entered (start and/or end)
                    const startVal = document.getElementById('startDate').value.trim();
                    const endVal = document.getElementById('endDate').value.trim();
                    if (startVal) params.append('start_date', startVal);
                    if (endVal) params.append('end_date', endVal);
                }

                const qs = params.toString();
                const href = `/history/${encodeURIComponent(it.name)}` + (qs ? `?${qs}` : '');

                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td data-order="${it.rank}">${it.rank}</td>
          <td><a href="${href}">
            ${capitalizeWords(it.name)}</a></td>
          <td data-order="${it.average_price || 0}">${convertEmeraldsToGameFormat(it.average_price)}</td>
          <td data-order="${it.lowest_price || 0}">${convertEmeraldsToGameFormat(it.lowest_price)}</td>
          <td data-order="${it.highest_price || 0}">${convertEmeraldsToGameFormat(it.highest_price)}</td>
          <td data-order="${it.average_mid_80_percent_price || 0}">${convertEmeraldsToGameFormat(it.average_mid_80_percent_price)}</td>
          <td data-order="${it.unidentified_average_mid_80_percent_price || 0}">${convertEmeraldsToGameFormat(it.unidentified_average_mid_80_percent_price)}</td>
          <td data-order="${it.total_count || 0}">${it.total_count}</td>
          <td data-order="${it.unidentified_count || 0}">${it.unidentified_count}</td>
        `;
                tbody.appendChild(tr);
            });

            // Initialize DataTable with responsive features
            dataTable = $('#rankingTable').DataTable({
                responsive: {
                    details: {
                        display: $.fn.dataTable.Responsive.display.childRowImmediate,
                        type: 'column',
                        renderer: function(api, rowIdx, columns) {
                            const data = $.map(columns, function(col, i) {
                                return col.hidden ?
                                    '<tr data-dt-row="'+col.rowIndex+'" data-dt-column="'+col.columnIndex+'">' +
                                    '<td class="fw-bold">'+col.title+':</td> ' +
                                    '<td>'+col.data+'</td>' +
                                    '</tr>' :
                                    '';
                            }).join('');

                            return data ? 
                                $('<table class="table table-sm table-bordered"></table>').append(data) : 
                                false;
                        }
                    }
                },
                paging: true,
                searching: true,
                ordering: true,
                info: true,
                autoWidth: false,
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                language: {
                    search: "Filter:",
                    lengthMenu: "Show _MENU_ entries",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    infoEmpty: "Showing 0 to 0 of 0 entries",
                    infoFiltered: "(filtered from _MAX_ total entries)"
                },
                columnDefs: [
                    { responsivePriority: 1, targets: [0, 1] }, // Rank and Item Name are highest priority
                    { responsivePriority: 2, targets: [2, 7] }, // Avg Price and Total Items are next priority
                    { responsivePriority: 3, targets: [3, 4, 5, 6, 8] } // Other columns are lower priority
                ],
                drawCallback: function() {
                    // Ensure responsive behavior is applied after each draw
                    $(window).trigger('resize');
                }
            });
        }

        window.onload = () => {
            function onlyOlderThan7Days(date) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const daysAgo = (today - date) / (1000 * 60 * 60 * 24);
                return daysAgo > 7;
            }

            // datepickers
            $('#startDate,#endDate').datepicker({
                format: 'yyyy-mm-dd',
                autoclose: true,
                todayHighlight: true
            });
            document.getElementById('applyFilter').onclick = () => fetchAndDisplay();
            document.getElementById('resetFilter').onclick = () => {
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
            };

            // init: parse URL params
            const p = new URLSearchParams(window.location.search);
            if (p.has('start_date') || p.has('end_date')) {
                activateDateRange(document.getElementById('btnRange'));
                document.getElementById('startDate').value = p.get('start_date') || '';
                document.getElementById('endDate').value = p.get('end_date') || '';
            } else {
                updateTimeframe(7, document.getElementById('btn7'));
            }
        };
    </script>
{% endblock %}
