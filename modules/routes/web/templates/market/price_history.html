{% extends '/components/_base.html' %}
{% block title %}Price History{% endblock %}
{% block content %}

    <h1 class="pt-2 px-4">Price History</h1>

    <!-- Input field for the item name -->
    <div class="row">
        <div class="input-group mb-3">
            <input type="text" class="form-control" aria-label="Item name" aria-describedby="searchBtn" id="itemSearch"
                   placeholder="Search Item: Hero, Dernic Ingot 3 ...">
            <button class="btn btn-primary" type="button" id="searchBtn">Search</button>
        </div>
    </div>

    <!-- Date range selectors (hidden until 'Date Range' clicked) -->
    <div class="row mb-3" id="dateRangeContainer" style="display: none;">
        <div class="col-md-3 mb-3">
            <label for="startDate" class="form-label">Start Date</label>
            <input type="text" class="form-control" id="startDate" placeholder="YYYY-MM-DD">
        </div>
        <div class="col-md-3 mb-3">
            <label for="endDate" class="form-label">End Date</label>
            <input type="text" class="form-control" id="endDate" placeholder="YYYY-MM-DD">
        </div>
        <div class="col-md-3 mb-3 d-flex align-items-end">
            <button id="applyFilter" class="btn btn-primary me-2">Apply</button>
            <button id="resetFilter" class="btn btn-secondary">Reset</button>
        </div>
    </div>

    <!-- Timeframe toggles -->
    <div class="row mb-3">
        <div class="col">
            <div class="btn-group btn-group-sm" role="group" aria-label="Timeframe toggles">
                <button type="button" class="btn btn-primary" id="btn7" onclick="updateTimeframe(7, this)">Last 7 days
                </button>
                <button type="button" class="btn btn-outline-primary" id="btn14" onclick="updateTimeframe(14, this)">
                    Last 14 days
                </button>
                <button type="button" class="btn btn-outline-primary" id="btn30" onclick="updateTimeframe(30, this)">
                    Last Month
                </button>
                <button type="button" class="btn btn-outline-primary" id="btn90" onclick="updateTimeframe(90, this)">
                    Last 3 Months
                </button>
                <button type="button" class="btn btn-outline-primary" id="btnRange" onclick="activateDateRange(this)">
                    Date Range
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col" style="min-height: 28vh;">
            <canvas id="priceHistoryChart"></canvas>
        </div>
    </div>
    <div class="row">
        <div class="col" style="min-height: 28vh;">
            <canvas id="highestPriceChart"></canvas>
        </div>
    </div>
    <div class="row">
        <div class="col" style="min-height: 28vh;">
            <canvas id="saturationChart"></canvas>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <p>* The data displayed on this page is always offset by 1 week. Live data can be viewed using in-game
                tooltips.</p>
        </div>
    </div>

    <!-- Add Chart.js, date adapter, and datepicker -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
    <script>
        let priceHistoryChart = null;
        let highestPriceChart = null;
        let saturationChart = null;
        let currentTimeframe = 7;

        function capitalizeWords(str) {
            const smallWords = ['of'];
            return str.split(' ').map((word, index) => {
                if (index === 0 || !smallWords.includes(word.toLowerCase())) {
                    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                }
                return word.toLowerCase();
            }).join(' ');
        }

        function convertEmeraldsToGameFormat(emeralds) {
            const stx = Math.floor(emeralds / (64 * 64 * 64));
            emeralds %= 64 * 64 * 64;
            const le = Math.floor(emeralds / (64 * 64));
            emeralds %= 64 * 64;
            const eb = Math.floor(emeralds / 64);
            const e = emeralds % 64;
            let result = '';
            if (stx > 0) {
                let decimalValue = le + eb / 64 + e / (64 * 64);
                decimalValue = Math.round(decimalValue * 100) / 100;
                const displayLE = Number.isInteger(decimalValue) ? decimalValue.toString() : decimalValue.toFixed(2);
                result = `${stx}stx${displayLE !== '0' ? ` ${displayLE}le` : ''}`;
            } else {
                if (le > 0) result += `${le}le `;
                if (eb > 0) result += `${eb}eb `;
                if (e > 0) result += `${e.toFixed(2)}e`;
            }
            return result.trim();
        }

        function initializeEmptyCharts() {
            [priceHistoryChart, highestPriceChart, saturationChart].forEach(c => c && c.destroy());
            const emptyData = {
                labels: [],
                datasets: [{label: 'No Data', data: [], borderColor: 'rgba(200,200,200,1)', fill: false}]
            };
            const opts = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {type: 'time', time: {unit: 'day'}, title: {display: true, text: 'Date'}},
                    y: {title: {display: true, text: 'Value'}}
                }
            };
            priceHistoryChart = new Chart(document.getElementById('priceHistoryChart'), {
                type: 'line',
                data: emptyData,
                options: opts
            });
            highestPriceChart = new Chart(document.getElementById('highestPriceChart'), {
                type: 'line',
                data: emptyData,
                options: opts
            });
            saturationChart = new Chart(document.getElementById('saturationChart'), {
                type: 'line',
                data: emptyData,
                options: opts
            });
        }

        function activateDateRange(btn) {
            // deactivate other toggles
            document.querySelectorAll('.btn-group button').forEach(b => {
                b.classList.replace('btn-primary', 'btn-outline-primary');
                b.classList.remove('active');
            });
            // activate Date Range
            btn.classList.replace('btn-outline-primary', 'btn-primary');
            btn.classList.add('active');
            // show date inputs
            document.getElementById('dateRangeContainer').style.display = 'flex';
        }


        const DEFAULT_LAG_DAYS = 8;
        const MS_PER_DAY = 24 * 60 * 60 * 1000;

        async function fetchPriceData(itemName) {
            try {
                const match = itemName.match(/^(.*?)(\d+)$/);
                let base = itemName, tier;
                if (match) {
                    base = match[1].trim();
                    tier = match[2].trim();
                }
                // get inputs / URL params
                const params = new URLSearchParams(window.location.search);
                const startVal = document.getElementById('startDate').value || params.get('start_date') || '';
                const endVal = document.getElementById('endDate').value || params.get('end_date') || '';
                // apply to inputs
                document.getElementById('startDate').value = startVal;
                document.getElementById('endDate').value = endVal;
                // if none provided, derive from timeframe
                let s = startVal, e = endVal;
                if (!s && !e) {
                    const now = new Date();
                    const lag = new Date(now.getTime() - DEFAULT_LAG_DAYS * MS_PER_DAY);
                    e = lag.toISOString().split('T')[0];
                    const begin = new Date(lag.getTime() - currentTimeframe * MS_PER_DAY);
                    s = begin.toISOString().split('T')[0];
                }
                const q = new URLSearchParams({start_date: s, end_date: e});
                if (tier) q.append('tier', tier);
                const url = `/api/trademarket/history/${encodeURIComponent(base)}?${q}`;
                const res = await fetch(url);
                const data = await res.json();
                if (res.ok && Array.isArray(data) && data.length) updateCharts(data); else initializeEmptyCharts();
            } catch (x) {
                console.error(x);
                initializeEmptyCharts();
            }
        }

        function updateCharts(priceData) {
            const labels = priceData.map(item => new Date(item.date));
            const averagePrices = priceData.map(item => item.average_price);
            const average80Prices = priceData.map(item => item.average_mid_80_percent_price);
            const unidentifiedAveragePrice = priceData.map(item => item.unidentified_average_price);
            const unidentifiedAverage80Prices = priceData.map(item => item.unidentified_average_mid_80_percent_price);
            const highestPrices = priceData.map(item => item.highest_price);
            const lowestPrices = priceData.map(item => item.lowest_price);
            const total_listings = priceData.map(item => item.total_count);
            const unid_listings = priceData.map(item => item.unidentified_count);

            if (priceHistoryChart) priceHistoryChart.destroy();
            if (highestPriceChart) highestPriceChart.destroy();
            if (saturationChart) saturationChart.destroy();

            // Price History Chart
            const ctx = document.getElementById('priceHistoryChart').getContext('2d');
            priceHistoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Average Price',
                            data: averagePrices,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Average 80% Price',
                            data: average80Prices,
                            borderColor: 'rgba(53, 134, 134, 1)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Unid Average Price',
                            data: unidentifiedAveragePrice,
                            borderColor: 'rgba(106, 93, 158, 1)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Unid Average 80% Price',
                            data: unidentifiedAverage80Prices,
                            borderColor: 'rgba(69, 53, 134, 1)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Lowest Price',
                            data: lowestPrices,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Price'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (tooltipItem) {
                                    const emeraldValue = tooltipItem.raw;
                                    const gameFormat = convertEmeraldsToGameFormat(emeraldValue);
                                    return `Price: ${emeraldValue}e (${gameFormat})`;
                                }
                            }
                        }
                    }
                }
            });

            // Highest Price Chart
            const ctx2 = document.getElementById('highestPriceChart').getContext('2d');
            highestPriceChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Highest Price',
                        data: highestPrices,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Price'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (tooltipItem) {
                                    const emeraldValue = tooltipItem.raw;
                                    const gameFormat = convertEmeraldsToGameFormat(emeraldValue);
                                    return `Price: ${emeraldValue}e (${gameFormat})`;
                                }
                            }
                        }
                    }
                }
            });

            // Saturation Chart
            const ctx3 = document.getElementById('saturationChart').getContext('2d');
            saturationChart = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Listings',
                            data: total_listings,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Unidentified Listings',
                            data: unid_listings,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Listings'
                            }
                        }
                    }
                }
            });
        }

        function handleSearch(item) {
            if (!item) return initializeEmptyCharts();
            const name = capitalizeWords(item);
            document.getElementById('itemSearch').value = name;
            const baseUrl = `/history/${encodeURIComponent(name)}`;
            history.replaceState(null, '', baseUrl + window.location.search);
            fetchPriceData(name);
        }

        function updateTimeframe(days, btn) {
            // clear URL params so manual range is ignored
            history.replaceState(null, '', location.pathname);

            document.getElementById('dateRangeContainer').style.display = 'none';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            currentTimeframe = days;
            document.querySelectorAll('.btn-group button').forEach(b => {
                b.classList.replace('btn-primary', 'btn-outline-primary');
                b.classList.remove('active');
            });
            btn.classList.replace('btn-outline-primary', 'btn-primary');
            btn.classList.add('active');
            const nm = document.getElementById('itemSearch').value.trim();
            if (nm) handleSearch(nm);
        }

        window.onload = () => {
            function onlyOlderThan7Days(date) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const daysAgo = (today - date) / (1000 * 60 * 60 * 24);
                return daysAgo > 7;
            }

            $('#startDate,#endDate').datepicker({
                format: 'yyyy-mm-dd',
                autoclose: true,
                todayHighlight: true,
                beforeShowDay: onlyOlderThan7Days
            });
            document.getElementById('searchBtn').onclick = () => handleSearch(document.getElementById('itemSearch').value.trim());
            document.getElementById('applyFilter').onclick = () => handleSearch(document.getElementById('itemSearch').value.trim());
            document.getElementById('resetFilter').onclick = () => {
                // Clear the inputs
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
                // Remove any start_date/end_date from the URL
                history.replaceState(null, '', location.pathname);
            };
            document.getElementById('itemSearch').addEventListener('keypress', e => {
                if (e.key === 'Enter') handleSearch(e.target.value.trim());
            });

            const initItem = '{{ item_name }}';
            const urlParams = new URLSearchParams(window.location.search);
            const sParam = urlParams.get('start_date');
            const eParam = urlParams.get('end_date');
            const presets = [7, 14, 30, 90];
            const MS_PER_DAY = 24 * 60 * 60 * 1000;

            if (sParam || eParam) {
                if (sParam && eParam) {
                    const sDate = new Date(sParam);
                    const eDate = new Date(eParam);
                    const diffDays = (eDate - sDate) / MS_PER_DAY;
                    // Compute lagged 'today'
                    const today = new Date();
                    const lagged = new Date(today.getTime() - DEFAULT_LAG_DAYS * MS_PER_DAY);
                    const lagISO = lagged.toISOString().split('T')[0];
                    console.log(lagISO)
                    let matched = false;
                    presets.forEach(d => {
                        if (!matched &&
                            Math.abs(diffDays - d) < 0.1 &&
                            eParam === lagISO &&
                            sParam === new Date(lagged.getTime() - d * MS_PER_DAY).toISOString().split('T')[0]
                        ) {
                            updateTimeframe(d, document.getElementById(`btn${d}`));
                            matched = true;
                        }
                    });
                    if (!matched) {
                        activateDateRange(document.getElementById('btnRange'));
                        document.getElementById('startDate').value = sParam;
                        document.getElementById('endDate').value = eParam;
                    }
                } else {
                    activateDateRange(document.getElementById('btnRange'));
                    if (sParam) document.getElementById('startDate').value = sParam;
                    if (eParam) document.getElementById('endDate').value = eParam;
                }
            } else {
                document.getElementById('btn7').click();
            }

            if (initItem && initItem !== 'None') {
                document.getElementById('itemSearch').value = capitalizeWords(initItem);
                handleSearch(initItem);
            } else {
                initializeEmptyCharts();
            }
        };
    </script>
{% endblock %}